import{j as e,u as k,e as T,a as L,r as i,c as $,M as P}from"./index-CvO9pKPC.js";import{I as A}from"./ImageWithFallback--6Rpc7vq.js";import{B as v}from"./badge-CXoDSUIB.js";import{I as D}from"./input-DnWsiyUA.js";import{S as E}from"./SignInView-CA7AgJIx.js";import{c as m}from"./chatSupabaseService-C5-xj_cv.js";import{S as r}from"./skeleton-D4u7SwtH.js";import{S as q}from"./search-B_nDvCvE.js";import{X as B}from"./x-wt5hBkWR.js";function O(){return e.jsxs("div",{className:"flex-1 bg-background pb-[74px]",children:[e.jsxs("div",{className:"bg-card px-4 pt-12 pb-6",children:[e.jsx(r,{className:"h-8 w-32 mb-2"}),e.jsx(r,{className:"h-4 w-64"})]}),e.jsxs("div",{className:"px-4 py-4",children:[e.jsx("div",{className:"mb-6",children:e.jsx(r,{className:"h-10 w-full rounded-md"})}),e.jsx("div",{className:"space-y-4",children:[...Array(6)].map((t,l)=>e.jsx("div",{className:"p-4 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx(r,{className:"w-12 h-12 rounded-full"}),l%2===0&&e.jsx(r,{className:"absolute bottom-0 right-0 w-3 h-3 rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx(r,{className:"h-5 w-32"}),l===0&&e.jsx(r,{className:"h-4 w-8"})]}),e.jsx(r,{className:"h-3 w-12"})]}),e.jsx(r,{className:"h-4 w-24 mb-1"}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(r,{className:"h-4 w-full"}),l%3===0&&e.jsx(r,{className:"h-5 w-6 rounded-full"})]})]})]})},l))})]})]})}function Y(){const{t}=k(),l=T(),d=L(),[o,h]=i.useState(""),[u,y]=i.useState([]),[C,p]=i.useState(!0),[Q,R]=i.useState(!0),{user:a}=$(),f=l.state?.selectedAgentId,c=i.useCallback(async()=>{if(a){p(!0);try{const s=await m.getMyConversations();y(s)}catch(s){console.error("Error loading conversations:",s)}finally{p(!1)}}},[a]),j=i.useCallback(async s=>{if(a)try{const n=await m.getOrCreateConversation({participant_user_id:s});n&&d(`/messages/chat/${n.id}`)}catch(n){console.error("Error creating conversation:",n)}},[a,d]);if(i.useEffect(()=>{a&&c()},[a,c]),i.useEffect(()=>{if(a)return m.subscribeToConversations(()=>{c()}),()=>{m.unsubscribeAll()}},[a,c]),i.useEffect(()=>{f&&a&&u.length>0&&j(f)},[f,a,u.length,j]),!a)return e.jsx(E,{title:"nav.messages",description:"messages.description",signInPrompt:"messages.signInPrompt",signInDescription:"messages.signInDescription",signInButtonText:"profile.signIn"});if(C)return e.jsx(O,{});const _=u.map(s=>({id:s.id,userName:s.other_user?.nickname||t("common.unknownUser"),userImage:s.other_user?.image||"/default-avatar.png",lastMessage:s.last_message_content||"",timestamp:new Date(s.updated_at),unreadCount:s.my_participant?.unread_count||0,requestTitle:s.request_id?`${t("common.request")} #${s.request_id.slice(0,8)}`:s.offer_id?`${t("common.offer")} #${s.offer_id.slice(0,8)}`:t("messages.directMessage"),isOnline:s.other_user?.is_online||!1,messageType:s.last_message_type||"text",isPinned:s.my_participant?.is_pinned||!1})),M=s=>{const x=new Date().getTime()-s.getTime(),g=Math.floor(x/6e4),b=Math.floor(x/36e5),w=Math.floor(x/864e5);return g<1?t("time.now"):g<60?t("time.minutesAgo",{count:g}):b<24?t("time.hoursAgo",{count:b}):w<7?t("time.daysAgo",{count:w}):s.toLocaleDateString()},S=s=>{switch(s.messageType){case"image":return`ðŸ“· ${t("messages.types.image")}`;case"location":return`ðŸ“ ${t("messages.types.location")}`;case"document":return`ðŸ“Ž ${t("messages.types.document")}`;default:return s.lastMessage}},N=[..._.filter(s=>s.userName.toLowerCase().includes(o.toLowerCase())||s.requestTitle.toLowerCase().includes(o.toLowerCase())||s.lastMessage.toLowerCase().includes(o.toLowerCase()))].sort((s,n)=>s.isPinned&&!n.isPinned?-1:!s.isPinned&&n.isPinned?1:n.timestamp.getTime()-s.timestamp.getTime());return e.jsxs("div",{className:"flex-1 bg-background pb-[74px]",children:[e.jsxs("div",{className:"bg-card px-4 pt-12 pb-6",children:[e.jsx("h1",{className:"text-3xl font-semibold text-foreground",children:t("messages.title")}),e.jsx("p",{className:"text-muted-foreground mt-1",children:t("messages.description")})]}),e.jsxs("div",{className:"px-4 py-4",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(D,{type:"text",placeholder:t("messages.search"),value:o,onChange:s=>h(s.target.value),className:"pl-10 pr-10"}),o&&e.jsx("button",{onClick:()=>h(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(B,{className:"h-4 w-4"})})]})}),N.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(P,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:t(o?"messages.empty.noResults":"messages.empty.noMessages")}),e.jsx("p",{className:"text-muted-foreground",children:t(o?"messages.empty.tryDifferentSearch":"messages.empty.startConversation")})]}):e.jsx("div",{className:"space-y-4",children:N.map(s=>e.jsx("div",{className:"p-4 bg-muted/50 rounded-lg cursor-pointer hover:bg-muted transition-colors",onClick:()=>I(s.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx(A,{src:s.userImage,alt:s.userName,className:"w-12 h-12 rounded-full object-cover"}),s.isOnline&&e.jsx("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-background rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground truncate",children:s.userName}),s.isPinned&&e.jsx(v,{variant:"secondary",className:"text-xs px-1.5 py-0",children:"ðŸ“Œ"})]}),e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:M(s.timestamp)})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-1 truncate",children:s.requestTitle}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:`text-sm truncate flex-1 ${s.unreadCount>0?"font-semibold text-foreground":"text-muted-foreground"}`,children:S(s)}),s.unreadCount>0&&e.jsx(v,{variant:"default",className:"text-xs px-2",children:s.unreadCount})]})]})]})},s.id))})]})]});function I(s){d(`/messages/chat/${s}`)}}export{Y as MessagesTab};
