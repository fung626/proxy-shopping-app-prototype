import{s as o}from"./index-CvO9pKPC.js";class g{orderSubscriptions=new Map;transformOrder(t){return{id:t.id,orderNumber:t.order_number,clientUserId:t.client_user_id,agentUserId:t.agent_user_id,requestId:t.request_id||void 0,offerId:t.offer_id||void 0,status:t.status,totalAmount:t.total_amount,currency:t.currency,paymentStatus:t.payment_status,paymentMethod:t.payment_method||void 0,paymentTransactionId:t.payment_transaction_id||void 0,paidAt:t.paid_at||void 0,deliveryMethod:t.delivery_method,deliveryAddress:t.delivery_address,trackingNumber:t.tracking_number||void 0,estimatedDeliveryDate:t.estimated_delivery_date||void 0,actualDeliveryDate:t.actual_delivery_date||void 0,confirmationPin:t.confirmation_pin||void 0,cancellationReason:t.cancellation_reason||void 0,refundAmount:t.refund_amount||void 0,refundReason:t.refund_reason||void 0,agentCommissionRate:t.agent_commission_rate,agentCommissionAmount:t.agent_commission_amount||void 0,metadata:t.metadata,createdAt:t.created_at,updatedAt:t.updated_at,cancelledAt:t.cancelled_at||void 0,completedAt:t.completed_at||void 0}}transformOrderItem(t){return{id:t.id,orderId:t.order_id,productName:t.product_name,productDescription:t.product_description||void 0,productImageUrl:t.product_image_url||void 0,quantity:t.quantity,unitPrice:t.unit_price,subtotal:t.subtotal,offerId:t.offer_id||void 0,specifications:t.specifications,metadata:t.metadata,createdAt:t.created_at,updatedAt:t.updated_at}}transformOrderHistory(t){return{id:t.id,orderId:t.order_id,status:t.status,previousStatus:t.previous_status||void 0,changedByUserId:t.changed_by_user_id||void 0,metadata:t.metadata,createdAt:t.created_at}}async createOrder(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");const r=t.items.reduce((a,d)=>a+d.quantity*d.unitPrice,0),n=0,i=r*n/100,s=`ORD-${Date.now()}-${Math.random().toString(36).substring(2,8).toUpperCase()}`,{data:c,error:u}=await o.from("orders").insert({order_number:s,client_user_id:e.id,agent_user_id:t.agentUserId,request_id:t.requestId||null,offer_id:t.offerId||null,status:"pending_payment",total_amount:r,currency:t.currency,payment_status:"pending",payment_method:t.paymentMethod||null,delivery_method:t.deliveryMethod,expected_meeting_location:t.expectedMeetingLocation||null,delivery_address:t.deliveryAddress,agent_commission_rate:n,agent_commission_amount:i}).select().single();if(u)throw u;const m=t.items.map(a=>({order_id:c.id,product_name:a.productName,product_description:a.productDescription||null,product_image_url:a.productImageUrl||null,quantity:a.quantity,unit_price:a.unitPrice,subtotal:a.quantity*a.unitPrice,offer_id:a.offerId||null,specifications:a.specifications||{}})),{error:l}=await o.from("order_items").insert(m).select();if(l)throw l;return await this.getOrderById(c.id)}catch(e){return console.error("Error creating order:",e),null}}async getOrderById(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:r,error:n}=await o.from("orders").select("*").eq("id",t).single();if(n)throw n;const{data:i,error:s}=await o.from("order_items").select("*").eq("order_id",t);if(s)throw s;const{data:c,error:u}=await o.from("users").select("*").eq("id",r.client_user_id).single();if(u)throw u;const{data:m,error:l}=await o.from("users").select("*").eq("id",r.agent_user_id).single();if(l)throw l;const{data:a,error:d}=await o.from("order_history").select("*").eq("order_id",t).order("created_at",{ascending:!1});if(d)throw d;const y=this.transformOrder(r),f=i.map(_=>this.transformOrderItem(_)),h=a.map(_=>this.transformOrderHistory(_));return{...y,items:f,client:c,agent:m,history:h}}catch(e){return console.error("Error getting order by ID:",e),null}}async getOrders(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");let r=o.from("orders").select("*");t?.role==="client"?r=r.eq("client_user_id",e.id):t?.role==="agent"?r=r.eq("agent_user_id",e.id):r=r.or(`client_user_id.eq.${e.id},agent_user_id.eq.${e.id}`),t?.status&&(Array.isArray(t.status)?r=r.in("status",t.status):r=r.eq("status",t.status)),t?.paymentStatus&&(Array.isArray(t.paymentStatus)?r=r.in("payment_status",t.paymentStatus):r=r.eq("payment_status",t.paymentStatus)),t?.startDate&&(r=r.gte("created_at",t.startDate)),t?.endDate&&(r=r.lte("created_at",t.endDate)),t?.minAmount!==void 0&&(r=r.gte("total_amount",t.minAmount)),t?.maxAmount!==void 0&&(r=r.lte("total_amount",t.maxAmount)),r=r.order("created_at",{ascending:!1});const{data:n,error:i}=await r;if(i)throw i;return(await Promise.all(n.map(c=>this.getOrderById(c.id)))).filter(c=>c!==null)}catch(e){return console.error("Error getting orders:",e),[]}}async getClientOrders(t){return this.getOrders({...t,role:"client"})}async getAgentOrders(t){return this.getOrders({...t,role:"agent"})}async getOrderStatistics(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");let r=o.from("orders").select("*");t==="client"?r=r.eq("client_user_id",e.id):t==="agent"?r=r.eq("agent_user_id",e.id):r=r.or(`client_user_id.eq.${e.id},agent_user_id.eq.${e.id}`);const{data:n,error:i}=await r;if(i)throw i;const s=n.length,c=n.reduce((a,d)=>a+d.total_amount,0),u=s>0?c/s:0,m=n.reduce((a,d)=>(a[d.status]=(a[d.status]||0)+1,a),{}),l=n.reduce((a,d)=>(a[d.payment_status]=(a[d.payment_status]||0)+1,a),{});return{totalOrders:s,totalRevenue:c,averageOrderValue:u,ordersByStatus:m,ordersByPaymentStatus:l}}catch(e){return console.error("Error getting order statistics:",e),null}}async updateOrder(t,e){try{const{data:{user:r}}=await o.auth.getUser();if(!r)throw new Error("User not authenticated");const n={};e.status!==void 0&&(n.status=e.status),e.paymentStatus!==void 0&&(n.payment_status=e.paymentStatus),e.paymentMethod!==void 0&&(n.payment_method=e.paymentMethod),e.paymentTransactionId!==void 0&&(n.payment_transaction_id=e.paymentTransactionId),e.trackingNumber!==void 0&&(n.tracking_number=e.trackingNumber),e.estimatedDeliveryDate!==void 0&&(n.estimated_delivery_date=e.estimatedDeliveryDate),e.actualDeliveryDate!==void 0&&(n.actual_delivery_date=e.actualDeliveryDate),e.notes!==void 0&&(n.notes=e.notes),e.cancellationReason!==void 0&&(n.cancellation_reason=e.cancellationReason),e.refundAmount!==void 0&&(n.refund_amount=e.refundAmount),e.refundReason!==void 0&&(n.refund_reason=e.refundReason),e.status==="cancelled"&&(n.cancelled_at=new Date().toISOString()),e.status==="completed"&&(n.completed_at=new Date().toISOString()),e.paymentStatus==="completed"&&!n.paid_at&&(n.paid_at=new Date().toISOString());const{data:i,error:s}=await o.from("orders").update(n).eq("id",t).select().single();if(s)throw s;return this.transformOrder(i)}catch(r){return console.error("Error updating order:",r),null}}async updateOrderStatus(t,e,r){return this.updateOrder(t,{status:e,notes:r,...e==="cancelled"&&r?{cancellationReason:r}:{}})}async cancelOrder(t,e){return this.updateOrder(t,{status:"cancelled",cancellationReason:e})}async completeOrder(t){return this.updateOrder(t,{status:"completed"})}async confirmPayment(t){return this.updateOrder(t,{status:"payment_confirmed",paymentStatus:"completed"})}async markAsProcessing(t){return this.updateOrder(t,{status:"processing"})}async markReadyForHandoff(t){return this.updateOrder(t,{status:"ready_for_handoff"})}async markAsShipped(t,e,r){return this.updateOrder(t,{status:"shipped",trackingNumber:e,estimatedDeliveryDate:r})}async markInTransit(t){return this.updateOrder(t,{status:"in_transit"})}async markAsDelivered(t,e){return this.updateOrder(t,{status:"delivered",actualDeliveryDate:e||new Date().toISOString()})}async confirmCompletion(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:r,error:n}=await o.from("orders").select("status").eq("id",t).single();if(n)throw n;const i=await this.updateOrder(t,{status:"completed"});return i&&await o.from("order_history").insert({order_id:t,status:"completed",previous_status:r.status,changed_by_user_id:e.id,metadata:{action:"confirm_completion",timestamp:new Date().toISOString()}}),i}catch(e){return console.error("Error confirming completion:",e),null}}async deleteOrder(t){try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:r,error:n}=await o.from("orders").select("status, client_user_id").eq("id",t).single();if(n)throw n;if(r.client_user_id!==e.id)throw new Error("Not authorized to delete this order");if(r.status!=="pending_payment")throw new Error("Can only delete orders with pending_payment status");const{error:i}=await o.from("orders").delete().eq("id",t);if(i)throw i;return!0}catch(e){return console.error("Error deleting order:",e),!1}}subscribeToOrder(t,e){this.unsubscribeFromOrder(t);const r=o.channel(`order-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"orders",filter:`id=eq.${t}`},n=>{e(n.new)}).subscribe();return this.orderSubscriptions.set(t,r),r}async unsubscribeFromOrder(t){const e=this.orderSubscriptions.get(t);e&&(await o.removeChannel(e),this.orderSubscriptions.delete(t))}subscribeToUserOrders(t){return o.channel("user-orders").on("postgres_changes",{event:"*",schema:"public",table:"orders"},e=>{t(e.eventType,e.new)}).subscribe()}async cleanupSubscriptions(){for(const[,t]of this.orderSubscriptions)await o.removeChannel(t);this.orderSubscriptions.clear()}}const p=new g;export{p as o};
