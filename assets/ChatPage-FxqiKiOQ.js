import{d as U,r as d,j as e,B as g,u as R,h as B,a as q,c as F,A as O}from"./index-CvO9pKPC.js";import{I as C}from"./ImageWithFallback--6Rpc7vq.js";import{c as v}from"./chatSupabaseService-C5-xj_cv.js";import{T as H}from"./textarea-TEs07ww8.js";import{M as K}from"./map-pin-BzPRdFpW.js";import{P as G}from"./plus-BEKpnawi.js";import{S as V}from"./send-CdZZTcNq.js";import{S as l}from"./skeleton-D4u7SwtH.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],Y=U("ellipsis-vertical",W);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],Q=U("image",J);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]],Z=U("paperclip",X);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],se=U("smile",ee);function ae({onSendMessage:a,onTyping:i,disabled:h=!1,placeholder:o="Type a message..."}){const[n,w]=d.useState(""),[p,m]=d.useState(!1),u=d.useRef(null),b=d.useRef(null),_=()=>{const x=n.trim();x&&!h&&(a(x,"text"),w(""),i?.(!1),u.current&&(u.current.style.height="auto"))},P=x=>{x.key==="Enter"&&!x.shiftKey&&(x.preventDefault(),_())},S=x=>{const j=x.target.value;w(j),i?.(j.length>0),u.current&&(u.current.style.height="auto",u.current.style.height=Math.min(u.current.scrollHeight,120)+"px")},D=()=>{b.current?.click()},M=x=>{const j=x.target.files?.[0];j&&(a(`Shared an image: ${j.name}`,"image"),m(!1))},I=()=>{a("Shared location","location"),m(!1)},$=()=>{a("Shared a document","document"),m(!1)};return e.jsxs("div",{className:"border-t border-border bg-card",children:[p&&e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs(g,{variant:"ghost",size:"sm",onClick:D,className:"flex flex-col items-center space-y-1 h-16 w-16",children:[e.jsx(Q,{className:"h-6 w-6 text-primary"}),e.jsx("span",{className:"text-xs",children:"Photo"})]}),e.jsxs(g,{variant:"ghost",size:"sm",onClick:I,className:"flex flex-col items-center space-y-1 h-16 w-16",children:[e.jsx(K,{className:"h-6 w-6 text-primary"}),e.jsx("span",{className:"text-xs",children:"Location"})]}),e.jsxs(g,{variant:"ghost",size:"sm",onClick:$,className:"flex flex-col items-center space-y-1 h-16 w-16",children:[e.jsx(Z,{className:"h-6 w-6 text-primary"}),e.jsx("span",{className:"text-xs",children:"Document"})]})]})}),e.jsxs("div",{className:"flex items-end space-x-2 p-4",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>m(!p),className:"h-10 w-10 flex-shrink-0",disabled:h,children:e.jsx(G,{className:`h-5 w-5 transition-transform ${p?"rotate-45":""}`})}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(H,{ref:u,value:n,onChange:S,onKeyPress:P,placeholder:o,disabled:h,className:"min-h-[40px] max-h-[120px] resize-none rounded-2xl border-muted bg-muted/50 px-4 py-2 pr-12 text-sm focus:border-primary focus:ring-1 focus:ring-primary",rows:1}),e.jsx(g,{variant:"ghost",size:"icon",className:"absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8",disabled:h,children:e.jsx(se,{className:"h-4 w-4 text-muted-foreground"})})]}),e.jsx(g,{onClick:_,disabled:!n.trim()||h,size:"icon",className:"h-10 w-10 rounded-full flex-shrink-0",children:e.jsx(V,{className:"h-4 w-4"})})]}),e.jsx("input",{ref:b,type:"file",accept:"image/*",onChange:M,className:"hidden"})]})}function te({message:a,otherUserAvatar:i,otherUserName:h,showAvatar:o}){const n=a.sender==="user",w=u=>u.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),p=()=>{if(!n)return null;switch(a.status){case"sending":return e.jsx("div",{className:"w-3 h-3 rounded-full bg-muted-foreground/50 animate-pulse"});case"sent":return e.jsx("div",{className:"w-3 h-3 rounded-full bg-muted-foreground"});case"delivered":return e.jsx("div",{className:"w-3 h-3 rounded-full bg-primary/60"});case"read":return e.jsx("div",{className:"w-3 h-3 rounded-full bg-primary"});default:return null}},m=()=>{switch(a.type){case"image":return e.jsxs("div",{className:"max-w-xs",children:[e.jsx(C,{src:a.imageUrl||"",alt:"Shared image",className:"rounded-lg w-full"}),a.content&&e.jsx("p",{className:"mt-2 text-sm",children:a.content})]});case"location":return e.jsxs("div",{className:"bg-muted/20 rounded-lg p-3 max-w-xs",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("div",{className:"w-6 h-6 bg-primary/20 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-xs",children:"ðŸ“"})}),e.jsx("span",{className:"font-medium text-sm",children:a.location?.name||"Location"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a.location?.address}),a.content&&e.jsx("p",{className:"mt-2 text-sm",children:a.content})]});case"document":return e.jsxs("div",{className:"bg-muted/20 rounded-lg p-3 max-w-xs",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/20 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs",children:"ðŸ“„"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:a.documentName||"Document"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"PDF â€¢ 2.1 MB"})]})]}),a.content&&e.jsx("p",{className:"mt-2 text-sm",children:a.content})]});default:return e.jsx("p",{className:"text-sm leading-relaxed",children:a.content})}};return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`flex ${n?"flex-row-reverse":"flex-row"} max-w-[80%] items-end space-x-2`,children:[!n&&o&&e.jsx(C,{src:i||"",alt:h||"User",className:"w-8 h-8 rounded-full object-cover flex-shrink-0"}),!n&&!o&&e.jsx("div",{className:"w-8"}),e.jsxs("div",{className:`rounded-2xl px-4 py-2 ${n?"bg-primary text-primary-foreground rounded-br-md":"bg-muted text-foreground rounded-bl-md"}`,children:[m(),e.jsxs("div",{className:`flex items-center justify-between mt-1 ${n?"flex-row-reverse":"flex-row"}`,children:[e.jsx("span",{className:`text-xs ${n?"text-primary-foreground/70":"text-muted-foreground"}`,children:w(a.timestamp)}),p()]})]})]})})}function re(){return e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("div",{className:"bg-card border-b border-border px-4 py-3 safe-area-inset-top",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(l,{className:"h-10 w-10 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[e.jsx(l,{className:"h-10 w-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsx(l,{className:"h-4 w-32"}),e.jsx(l,{className:"h-3 w-20"})]})]}),e.jsx(l,{className:"h-10 w-10 rounded-lg flex-shrink-0"})]}),e.jsx("div",{className:"mt-2",children:e.jsx(l,{className:"h-6 w-40 rounded-full"})})]}),e.jsxs("div",{className:"flex-1 overflow-hidden p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(l,{className:"h-8 w-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(l,{className:"h-20 w-3/4 rounded-2xl"}),e.jsx(l,{className:"h-3 w-16"})]})]}),e.jsx("div",{className:"flex items-start space-x-2 justify-end",children:e.jsxs("div",{className:"space-y-2 flex-1 flex flex-col items-end",children:[e.jsx(l,{className:"h-16 w-2/3 rounded-2xl"}),e.jsx(l,{className:"h-3 w-16"})]})}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(l,{className:"h-8 w-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(l,{className:"h-24 w-4/5 rounded-2xl"}),e.jsx(l,{className:"h-3 w-16"})]})]}),e.jsx("div",{className:"flex items-start space-x-2 justify-end",children:e.jsxs("div",{className:"space-y-2 flex-1 flex flex-col items-end",children:[e.jsx(l,{className:"h-12 w-1/2 rounded-2xl"}),e.jsx(l,{className:"h-3 w-16"})]})})]}),e.jsx("div",{className:"bg-card border-t border-border p-4 safe-area-inset-bottom",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(l,{className:"h-10 w-10 rounded-lg flex-shrink-0"}),e.jsx(l,{className:"h-10 flex-1 rounded-lg"}),e.jsx(l,{className:"h-10 w-10 rounded-lg flex-shrink-0"})]})})]})}function ue(){const{t:a}=R(),{id:i}=B(),h=q(),{user:o}=F(),[n,w]=d.useState(null),[p,m]=d.useState([]),[u,b]=d.useState(!0),[_,P]=d.useState(!1),S=d.useRef(null),D=d.useCallback(async()=>{if(!(!i||!o)){b(!0);try{const s=await v.getConversationById(i);w(s);const c=await v.getMessages(i);m(c),await v.markAsRead({conversation_id:i})}catch(s){console.error("Error loading conversation:",s)}finally{b(!1)}}},[i,o]);d.useEffect(()=>{D()},[D]),d.useEffect(()=>{if(i)return v.subscribeToMessages(i,s=>{m(c=>c.some(r=>r.id===s.id)?c:[...c,s]),s.sender_id!==o?.id&&v.markAsRead({conversation_id:i})}),()=>{v.unsubscribeFromMessages(i)}},[i,o?.id]),d.useEffect(()=>{S.current?.scrollIntoView({behavior:"smooth"})},[p]),d.useEffect(()=>{if(i)return()=>{}},[i]);const M=()=>{h("/messages")},I=async(s,c)=>{if(!i||!o)return;const t={id:`temp-${Date.now()}`,conversation_id:i,sender_id:o.id,content:s,message_type:c,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_edited:!1,is_deleted:!1,sender:{id:o.id,nickname:o.nickname||o.name||"You",image:o.avatar||null}};m(r=>[...r,t]);try{const r=await v.sendMessage({conversation_id:i,content:s,message_type:c});r&&m(f=>f.map(y=>y.id===t.id?r:y))}catch(r){console.error("Error sending message:",r),m(f=>f.filter(y=>y.id!==t.id))}},$=s=>{if(!s)return"";const t=Math.floor((new Date().getTime()-s.getTime())/(1e3*60));return t<1?a("messages.activeNow"):t<60?a("messages.activeMinutesAgo",{count:t}):t<1440?a("messages.activeHoursAgo",{count:Math.floor(t/60)}):a("messages.activeDaysAgo",{count:Math.floor(t/1440)})},x=s=>{const c=[];let t="",r=[];return s.forEach(f=>{const y=f.timestamp.toDateString();y!==t?(r.length>0&&c.push({date:t,messages:r}),t=y,r=[f]):r.push(f)}),r.length>0&&c.push({date:t,messages:r}),c},j=s=>{const c=new Date(s),t=new Date,r=new Date(t);return r.setDate(r.getDate()-1),c.toDateString()===t.toDateString()?a("messages.today"):c.toDateString()===r.toDateString()?a("messages.yesterday"):c.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})};if(u)return e.jsx(re,{});if(!n)return e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4 text-gray-600 dark:text-gray-400",children:"Conversation not found"}),e.jsx(g,{onClick:M,children:"Back to Messages"})]})});const A=p.map(s=>({id:s.id,content:s.content,sender:s.sender_id===o?.id?"user":"other",timestamp:new Date(s.created_at),type:s.message_type,status:"delivered",imageUrl:s.image_url||void 0,documentName:s.document_name||void 0,location:s.location_name?{name:s.location_name,address:s.location_address||""}:void 0})),L=x(A);let N=n.other_user;if(!N&&n.participants){const s=n.participants.find(c=>c.user_id!==o?.id);s&&(N={id:s.user_id,nickname:"User",image:"",is_online:!1})}const k=N?.nickname||"Unknown User",E=N?.image||"",T=N?.is_online||!1,z=n.request_id?`${a("common.request")} #${n.request_id.slice(0,8)}`:n.offer_id?`${a("common.offer")} #${n.offer_id.slice(0,8)}`:a("messages.directMessage");return e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsx("div",{className:"bg-card border-b border-border px-4 py-3 safe-area-inset-top",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:M,className:"h-10 w-10",children:e.jsx(O,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx(C,{src:E,alt:k,className:"w-10 h-10 rounded-full object-cover"}),T&&e.jsx("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-card"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"font-semibold text-foreground truncate",children:k}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:z}),T?e.jsx("p",{className:"text-xs text-green-600",children:a("messages.online")}):e.jsx("p",{className:"text-xs text-muted-foreground",children:N?.last_seen?$(N.last_seen):a("messages.offline")})]})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx(g,{variant:"ghost",size:"icon",className:"h-10 w-10",children:e.jsx(Y,{className:"h-5 w-5"})})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-4",children:[L.map((s,c)=>e.jsxs("div",{children:[s.date&&e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("div",{className:"bg-muted px-3 py-1 rounded-full",children:e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:j(s.date)})})}),s.messages.map((t,r)=>{const f=t.sender==="other"&&(r===0||s.messages[r-1]?.sender==="user");return e.jsx(te,{message:t,otherUserAvatar:E,otherUserName:k,showAvatar:f},t.id)})]},c)),_&&e.jsx("div",{className:"flex justify-start mb-4",children:e.jsxs("div",{className:"flex items-end space-x-2 max-w-[80%]",children:[e.jsx(C,{src:E,alt:k,className:"w-8 h-8 rounded-full object-cover flex-shrink-0"}),e.jsx("div",{className:"bg-muted rounded-2xl rounded-bl-md px-4 py-2",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})})]})}),e.jsx("div",{ref:S})]}),e.jsx(ae,{onSendMessage:I,onTyping:s=>{console.log("Current user typing:",s)},placeholder:a("messages.messagePlaceholder",{name:k})})]})}export{ue as ChatPage};
