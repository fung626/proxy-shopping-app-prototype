import{s as d,k as y,p as _,l}from"./index-CvO9pKPC.js";import{o as p}from"./offersSupabaseService-BThdOnLG.js";import{r as W}from"./requestsSupabaseService-soQQ1D_i.js";class f{async getWishlistByUser(o){try{const{data:e,error:t}=await d.from("wishlists").select("*").eq("user_id",o).order("created_at",{ascending:!1});if(t)throw console.error("Error fetching wishlist:",t),t;const s=e||[],r=[],a=[];for(const i of s)i.item_type==="offer"&&r.push(i.item_id),i.item_type==="request"&&a.push(i.item_id);let m=[],h=[];try{r.length>0&&(m=await p.getOfferByIds(r))}catch(i){console.warn("Failed to fetch offers for wishlist:",i)}try{a.length>0&&(h=await W.getRequesByIds(a))}catch(i){console.warn("Failed to fetch requests for wishlist:",i)}return s.map(i=>{const w={id:i.id,user_id:i.user_id,item_id:i.item_id,item_type:i.item_type,created_at:i.created_at};return i.item_type==="offer"?w.offer=m.find(u=>u.id===i.item_id):i.item_type==="request"&&(w.request=h.find(u=>u.id===i.item_id)),w})}catch(e){throw console.error("getWishlistByUser error:",e),e}}async isItemWishlisted(o,e){try{const{data:t,error:s}=await d.from("wishlists").select("id").eq("user_id",o).eq("item_id",e).limit(1).single();if(s&&s.code!=="PGRST116"){if(s.code==="PGRST116")return!1;throw console.error("isItemWishlisted error:",s),s}return!!t}catch{return!1}}async addWishlistItem(o,e,t){try{const{data:s,error:r}=await d.from("wishlists").insert([{user_id:o,item_id:e,item_type:t}]);if(r){if(r?.code==="23505")return!0;throw console.error("Error adding wishlist item:",r),r}return s?.[0]||null}catch(s){throw console.error("addWishlistItem error:",s),s}}async removeWishlistItem(o,e){try{const{error:t}=await d.from("wishlists").delete().eq("user_id",o).eq("item_id",e);if(t)throw console.error("Error removing wishlist item:",t),t;return!0}catch(t){throw console.error("removeWishlistItem error:",t),t}}}const c=new f,q=Object.freeze(Object.defineProperty({__proto__:null,WishlistSupabaseService:f,wishlistSupabaseService:c},Symbol.toStringTag,{value:"Module"})),b=y()(_((n,o)=>({wishlist:new Set,addWishlistItem:e=>{const{wishlist:t}=o(),s=new Set(t);s.add(e),n({wishlist:s}),(async()=>{try{const{data:r}=await l.getCurrentUser(),a=r.user;if(!a)return;await c.addWishlistItem(a.id,e.id,e.type)}catch(r){console.warn("Failed to add remote wishlist item",r)}})()},syncWithServer:async()=>{try{const{data:e}=await l.getCurrentUser(),t=e.user;if(!t)return;const s=await c.getWishlistByUser(t.id),r=new Set((s||[]).map(a=>({id:a.item_id,type:a.item_type})));n({wishlist:r})}catch(e){console.warn("Failed to sync wishlist with server",e)}},fetchRemoteWishlist:async()=>{await o().syncWithServer()},addRemoteItem:async(e,t)=>{try{const{data:s}=await l.getCurrentUser(),r=s.user;if(!r)return;await c.addWishlistItem(r.id,e,t)}catch(s){console.warn("Failed to add remote wishlist item",s)}},removeRemoteItem:async e=>{try{const{data:t}=await l.getCurrentUser(),s=t.user;if(!s)return;await c.removeWishlistItem(s.id,e)}catch(t){console.warn("Failed to remove remote wishlist item",t)}},removeWishlistItem:e=>{const{wishlist:t}=o(),s=new Set(t);for(const r of s)if(r.id===e){s.delete(r);break}n({wishlist:s}),(async()=>{try{const{data:r}=await l.getCurrentUser(),a=r.user;if(!a)return;await c.removeWishlistItem(a.id,e)}catch(r){console.warn("Failed to remove remote wishlist item",r)}})()},toggleWishlistItem:(e,t)=>{const{wishlist:s,addWishlistItem:r,removeWishlistItem:a}=o();Array.from(s).find(h=>h.id===e)?a(e):t&&r({id:e,type:t})},isWishlistItem:e=>{const{wishlist:t}=o();return Array.from(t).some(s=>s.id===e)},getWishlist:()=>{const{wishlist:e}=o();return Array.from(e)},clearWishlist:()=>{n({wishlist:new Set})},getWishlistCount:()=>o().wishlist.size}),{name:"wishlist-storage",partialize:n=>({wishlist:Array.from(n.wishlist)}),merge:(n,o)=>({...o,wishlist:new Set(n?.wishlist||[])})}));export{b as u,q as w};
